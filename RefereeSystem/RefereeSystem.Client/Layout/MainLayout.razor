@inherits LayoutComponentBase
@using RefereeSystem.Client.Services
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject ILocalStorageService LocalStorage
@inject NavigationManager NavManager
@implements IDisposable

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <AuthorizeView>
                <Authorized>
                    <div class="d-flex align-items-center gap-3 w-100 justify-content-end">

                        <div class="d-flex align-items-center text-dark">
                            <i class="bi bi-person-circle fs-5 me-2 text-success"></i>
                            <span class="fw-bold">@context.User.Identity?.Name</span>
                        </div>

                        <div class="vr"></div>

                        @if (timeLeft.TotalSeconds > 0)
                        {
                            <span class="@GetTimerColor() fw-bold" style="min-width: 90px; text-align: right;">
                                <i class="bi bi-clock-history me-1"></i>
                                @timeLeft.ToString(@"mm\:ss")
                            </span>
                        }

                        <button class="btn btn-outline-danger btn-sm ms-2" @onclick="Logout" title="Wyloguj">
                            <i class="bi bi-power"></i>
                        </button>
                    </div>
                </Authorized>

                <NotAuthorized>
                    <a href="https://www.laczynaspilka.pl/" target="_blank" class="ms-auto text-decoration-none text-muted small">
                        £¹czy Nas Pi³ka <i class="bi bi-box-arrow-up-right ms-1"></i>
                    </a>
                </NotAuthorized>
            </AuthorizeView>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

@code {
    private System.Timers.Timer? _timer;
    private DateTime tokenExpiration;
    private TimeSpan timeLeft;

    protected override async Task OnInitializedAsync()
    {
        NavManager.LocationChanged += OnLocationChanged;
        await UpdateExpirationDate();

        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += async (sender, e) => await OnTimerTick();
        _timer.AutoReset = true;
        _timer.Enabled = true;
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await UpdateExpirationDate();
        await OnTimerTick();

        // Safety check: restart timer if stopped
        if (_timer != null && !_timer.Enabled) _timer.Start();
    }

    private async Task UpdateExpirationDate()
    {
        if (AuthStateProvider is CustomAuthStateProvider authProvider)
        {
            tokenExpiration = await authProvider.GetTokenExpirationAsync();
        }
        else
        {
            tokenExpiration = DateTime.MinValue;
        }
    }

    private async Task OnTimerTick()
    {
        if (tokenExpiration == DateTime.MinValue)
        {
            timeLeft = TimeSpan.Zero;
        }
        else
        {
            var diff = tokenExpiration - DateTime.UtcNow;

            if (diff.TotalSeconds > 0)
            {
                timeLeft = diff;
            }
            else
            {
                // Time's up!
                timeLeft = TimeSpan.Zero;
                tokenExpiration = DateTime.MinValue; // Stop trying to calculate diff

                // Do not stop timer, just logout
                await Logout();
            }
        }
        await InvokeAsync(StateHasChanged);
    }

    private string GetTimerColor()
    {
        if (timeLeft.TotalMinutes < 2) return "text-danger";
        if (timeLeft.TotalMinutes < 5) return "text-warning";
        return "text-success";
    }

    private async Task Logout()
    {
        // 1. Reset local timer variables immediately so UI updates fast
        tokenExpiration = DateTime.MinValue;
        timeLeft = TimeSpan.Zero;

        // 2. Perform actual logout logic
        if (AuthStateProvider is CustomAuthStateProvider authProvider)
        {
            await LocalStorage.RemoveItemAsync("authToken"); // Clear token manually first
            authProvider.NotifyUserLogout(); // Tell app state changed
            NavManager.NavigateTo("/login");
        }

        // 3. Force UI refresh (Crucial for AuthorizeView to switch to NotAuthorized)
        StateHasChanged();
    }

    public void Dispose()
    {
        NavManager.LocationChanged -= OnLocationChanged;
        _timer?.Dispose();
    }
}